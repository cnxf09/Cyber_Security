# 传输层协议常见攻击与防范

## 传输层协议简介

- TCP
- UDP

### TCP报文格式

![image-20251210215412828](./4_%E4%BC%A0%E8%BE%93%E5%B1%82%E5%AE%89%E5%85%A8.assets/image-20251210215412828.png)

### TCP三次握手

- 第一次握手:客户端发送SYN报文. TCP连接的发起方(客户端)发起一个TCP报文,该报文的==SYN标志位被置为1==.==序列号设置为一个生成的随机值X==
- 第二次握手:服务器回应**SYN-ACK报文**.服务器在接收到客户端的连接请求后,恢复一个包含SYN和ACK标志为均被置为1的TCP报文.此报文表示服务器收到连接请求并准备和客户端建立连接.服务器生成一个新的随机值Y作为其序列号.同时报文的确认好设置为X+1表示服务器期望接收的下一对端序列号
- 第三次握手: 客户端发送ACK报文.客户端回复一个ACK报文,表明客户端同意并确认连接的建立.此ACK报文的序列号被设置为X+1,确认好被设置为Y+1.

### TCP传输窗口

- 发送窗口: 由接收方通告的传输窗口大小决定,表示发送方在等待确认之前可以发送的最大数据量
- 接收窗口: 接收方根据自己的缓冲区大小,通告能够接收的数据量

### TCP状态自动机

> TCP协议在工作时，通信双方可能会处于不同的阶段，分别包括连接建立、数据传输和连接终止。通信双方在TCP会话时都需要维护各自的状态，根据当前状态和接收到的报文进行状态转换。这种状态转换的过程通常用有限状态机（Finite-State Machine，FSM）进行描述。

例如

- CLOSED:无连接的初始状态
- LISTEN:服务器监听,等待请求
- SYN_SENT:客户端已发送SYN,等待响应

### TCP socket编程

略

### UDP报文格式

UDP报文头部长度固定为**8字节**包含一次啊自私字段

- 源端口
- 目的端口
- 长度: 整个UDP报文的长度==包括头部和数据部分==
- 校验和

### 协议端口

> 端口是TCP/IP协议族中的重要标识,用户软件通信在操作系统层面的连接断电,操作系统需要通过不同的端口来进一步区分当前收到的报文应该向哪个应用程序呈交

- TCP/UDP协议的网络连接会话,可通过五元组信息实现唯一标识

  ```text
  <源地址,目的地址,源端口,目的端口,协议>
  ```

- 端口号**16位**,范围从**0到65535**

  - 端口号0: 保留端口不可使用
  - 知名端口(1~1023):系统或特权用户使用
  - 注册端口(1024~49151): 特定的服务或应用程序
  - 动态/私有端口(49152~65535):临时或私有的连接

## 传输层常见攻击原理

- TCP端口扫描及资产探查
- TCP SYN flood攻击与防范
- TCP会话的重置与劫持
- 反射放大攻击

### TCP端口扫描

#### TCP全连接扫描和半连接扫描

- 原理
  - 发送SYN数据包
    - 若返回**SYN+ACK**则端口开启
    - 若返回**RST**则端口关闭

- TCP全连接扫描
  - 若端口开放,收到响应后继续发送**ACK**,==建立真实的TCP连接==
  - 准确,但效率低,会留下明显的日志记录
- TCP半连接扫描
  - 收到响应后立即**RST**终止
  - 扫描速度快,具有一定的隐蔽性

#### TCP Maimon扫描等其他特殊扫描

- **TCP Maimon扫描**
  - 向目标端口的TCP连接发送一个同时设置**FIN**和**ACK**标志为的数据包
    - 如果端口开放,目标端口忽略这类非法数据,==无响应==
    - 如果端口是关闭的,则会响应RST报文

- **TCP NUll扫描**
  - 发送一个不带有任何TCP标志的数据包
- **TCP FIN扫描**
  - 发送只设置了**FIN**标志位的TCP数据包
- **TCP Xmas扫描**
  - 数据包中设置多标志位(**FIN**,**PSH**,**URG**)
- 以上四种扫描的判断逻辑都是一样的

### UDP扫描

- 扫描者向目标端口发送一个空的UDP请求
  - 如果收到了ICMP不可到达错误,则表示端口关闭
  - 收到响应报文则表明端口开放

### 隐蔽扫描

- 扫描者A向C发送发送ICMP请求,C恢复ICMP响应,A记录下IPID=n

  > [!note]
  >
  > IP报文头部的Identification字段,某些系统每发一个包就递增1

- 扫描者A伪装源IP为C,向目标B的某端口发送SYN包.B以为是C在请求连接

- B的响应影响C的IPID

  - 若B的端口开放:B向C发送**SYN+ACK**; C回复**RST**; C的**IPID+1**.
  - 若B的端口关闭:B向C发送**RST**; C收到RST,**直接忽略**; C的**IPID不变**

- A再次探测C的IPID:扫描者A再次向C发送ICMP请求,比较前后IPID的变化

  - 若B端口开放: IPID增加2
  - 若端口B关闭:IPID增加1

- 目标主机B的日志中只会记录空闲主机C的IP,完全看不到扫描者A的存在

- 局限性

  - 需要找到IPID全局递增且空闲的主机
  - 现代系统大多使用随机IPID或基于哈希的IPID,这种扫描已很难实现
  - 空闲主机如果有其他流量则会干扰判断

- 其他隐蔽扫描

  - TCP RST速率限制:

    > 基于TCP RST速率的隐蔽扫描方法，利用了操作系统的TCP
    >
    > 协议栈在短时间内能够发送的RST报文数量有限这一固有特性。具体而言，攻击者通过观察空闲主机是否仍然能够发送RST报文，间接地判定其是否收到了目标主机发送的SYN-ACK报文，从而判断目的端口是否开放。

  - IPv6 IPID速率限制:

    > Pv6协议中也对IPID速率有所限制，扫描者通过观测目标系统的IPID值变化来间接地判断端口状态。这种方法在IPv6网络中具有一定的隐蔽性。

### 资产探查

> 设备与协议的指纹识别：在现实世界中，不同的网络设备、协议实现和软件应用在网络连接中可能会表现出极为细微的差异。这些在通信连接中表现出来的独特特性被称为设备、系统或软件的“指纹（Fingerpint)”。

- 操作系统的指纹识别
  - 被动指纹(只监听,不发包)
    - TCP/IP栈指纹: TTL,windows size ,IPID,TCP选项顺序等
    - 应用层/浏览器指纹: HTTP header,cookie特征,TLS指纹,DNS查询指纹
  - 主动指纹(向目标发送特殊探测包,观察响应差异):
    - TCP/IP主动栈探测: 发送特殊狗仔的TCP/IP包,根据响应差异匹配指纹库
    - 应用协议横幅/版本探测: 连接服务端口, 读取banner或协议特性(如SSH握手中的版本字符串)

### TCP SYN flood攻击

- 原理: 攻击者向目标发送大量SYN请求,但故意不完成三次握手的第三步,即不发送ACK
- 攻击步骤
  1. 攻击者发送大量SYN
  2. 受害者为每个SYN分配资源,恢复SYN+ACK,进入SYN_RCVD状态
  3. 攻击者不回复ACK,受害者持续等待
  4. 半开连接队列被填满,无法响应正常用户请求
- 防范措施
  - 增加半开队列的长度
  - 降低队列中表项的回收时间

### TCP SYN Cookie

有效防范TCP洪泛攻击的办法

- 工作原理
  1. 服务器收到SYN包
  2. 不分配资源,而是根据**(源IP、源端口、目的IP、目的端口、序列号等)**计算一个cookie值
  3. 将cookie值作为SYN+ACK的初始序列号发送给客户端
  4. 收到客户端ACK后,从确认号(ACK-1)反推并验证cookie
  5. 验证通过才分配资源,建立连接
- 把连接状态编码再序列号中,而不是存储在服务器内存里

### TCP会话的劫持与重置

如果一旦TCP的序列号可以被攻击者预测或推测,那么攻击者就完全有可能向TCP连接中注入恶意的TCP报文,从而干扰或劫持整个TCP会话

### TCP序列号随机化

- 早期问题
  - 大部分系统采用全局时钟发生器产生初始序列号,呈线性增长
  - 攻击方法: 攻击者先与目标建立一个TCP连接,即可获取当前全局计数器的值,从而预测下一个连接的序列号
- 会话劫持示例(Telnet)
  1. 客户端与Telnet正常通信
  2. 攻击者预测序列号后,伪造源IP注入恶意命令
  3. 服务器执行攻击者的命令
  4. 原客户端序列号被扰乱,无法正常通信
- 互联网技术标准RFC 1948中引入了初始序列号的随机化机制
  - 可以利用侧信道攻击.
  - 原理:RFC规定收到序列号错误的TCP报文时,会恢复ACK告知正确的序列号,攻击者利用这点,通过观察目标IPID变化来验证猜测是否正确
    1. 向客户端发送ICMP,记录IPID=x
    2. 伪造服务器IP,向客户端发送猜测序列号的TCP报文
    3. 再次发送ICMP,检查IPID变化
       - IPID增加1,预测正确(客户端没回复ACK)
       - IPID增加2,预测错误(客户端回复了ACK,IPID多加了1)

### TCP重置攻击

1. 攻击者获取/猜测目标连接的序列号
2. 伪造IP地址,构造RST报文
3. 注入到通信流量中
4. 客户端收到RST,连接被强制断开

### 网络过滤

![image-20251212150536952](./4_%E4%BC%A0%E8%BE%93%E5%B1%82%E5%AE%89%E5%85%A8.assets/image-20251212150536952.png)

### 反射放大攻击

- 基本原理: 攻击者伪造源IP地址为受害者地址,向服务提供者发送请求,响应被"反射"给受害者
  - 反射: 伪造源地址,让响应发送给受害者
  - 放大: 响应报文远大于请求报文

- TCP反射放大攻击
  - 传统观点认为TCP需要三次握手,无法伪造源IP进行反射
  - 新发现: 防火墙等中间盒子在蓝泽TCP时,不需要哦完整握手就会响应,且阻断响应通常比请求大.==攻击者可以故意触发这些中间盒子==实现TCP反射放大
- CDN反射放大攻击
  - 原理:CDN缓存记者的特性:客户端请求负分内容时,CDN可能向源站请求整个资源
  - 攻击者精心构造的小请求$\to$CDN向源站请求大文件$\to$造成CDN和源站的负载压力(RangeAmp攻击)

