# 局域网安全

## 物理层

### 连接设备类型

|    设备    |  工作层次  |            说明             |
| :--------: | :--------: | :-------------------------: |
|   集线器   |   物理层   | 简单信号放大,广播到所有端口 |
|    网桥    | 数据链路层 |       基于MAC地址转发       |
|   路由器   |   网络层   |       基于IP地址转发        |
| 二层交换机 | 数据链路层 |    高速网桥,基于MAC地址     |
| 三层交换机 |   网络层   |    具备路由功能的交换机     |

### 物理接口和物理网卡

- Physical Interface — 物理接口: 对应真实的物理网卡
- Loopback/Dummy Interface — 回环/虚拟接口
  - `lo`接口: 发送的数据直接回环到接收队列,不经过任何物理介质.可用于本机进程间通信、本机服务测试
  - Dummy：用于创建额外的虚拟接口，常用于路由/测试场景
    - 类似于回环，但是有自己的IP和MAC地址
- TUN/TAP Interface — 用户态隧道接口：数据不是发往网络，而是发给用户态程序
  - TUN：工作在IP层，处理IP包
  - TAP：工作在数据链路层，处理以太网帧
  - 如VPN软件和虚拟机网络（Host-Only模式）

## 局域网协议概述(I)

- IEEE 802协议簇：从802.1编号到了802.24

  - 802.3是有线以太网协议
  - 802.11是无线以太网协议

- 以太网络协议(802.3协议)

  > 该协议规范了以太网络的**物理层**和**数据链路层**，使得各种以太网技术能够在局域网中实现高速、可靠的数据传输。

## 以太网协议

### 以太网帧字段详解

|     字段     | 长度(字节) |              作用               |
| :----------: | :--------: | :-----------------------------: |
|    前导码    |     7      |  `101010...`交替,用于时钟同步   |
| 起始帧定界符 |     1      |    `10101011`,标志帧正式开始    |
| 目的MAC地址  |     6      |         接收方的MAC地址         |
|  源MAC地址   |     6      |        发送方的物理地址         |
|  长度/类型   |     2      | ≤1500表示长度;>1536表示协议类型 |
|     数据     |  46-1500   |    上层协议数据(IP包,ARP等)     |
|  帧校验序列  |     4      |     CRC-32校验,检测传输错误     |

### CSMA/CD协议

载波监听多路访问/冲突检测

- 监听空闲信道: 先听后发,信道忙则等待
- 发送数据: 空闲96-bit时间后开始发送
- 冲突检测: 边听边发,检测是否有冲突
- 随机退避: 检测到冲突后使用二进制指数退避算法

## 局域网协议概述(II)

- ARP协议(地址解析协议)

  主要功能是将网络层的IP地址解析为数据链路层的物理地址(通常是MAC)地址

- MAC地址

## ARP协议

### ARP协议格式

|    字段    | 长度(字节) |          说明          |
| :--------: | :--------: | :--------------------: |
|   Htype    |     2      |        硬件类型        |
|   Ptype    |     2      |        协议类型        |
|    Hlen    |     1      |      硬件地址长度      |
|    Plen    |     1      |      协议地址长度      |
|     Op     |     2      | 操作码(1=请求,2=响应)  |
| Sender MAC |     6      |     发送方MAC地址      |
| Sender IP  |     4      |      发送方IP地址      |
| Target MAC |     6      | 目标MAC地址(请求时全0) |
| Target IP  |     4      |       目标IP地址       |

### ARP协议的工作流程

- **发起ARP请求**: 当主机A想与局域网内的另一台主机B通信时, A先检查自己的ARP缓存表,查看是否已经有B的IP地址对应的MAC地址.如果没有,A将广播一个ARP请求包到局域网中,询问B的IP地址对应的MAC地址.

- **广播消息**: 局域网内的所有设备都能收到来自A的请求

- **ARP响应**: 当网络中的逐句B识别到ARP请求中的IP地址与自己的IP时钟相匹配时,它会向发起ARP请求的设备发送一个ARP响应.这个响应包含B的IP地址和MAC地址

- **添加缓存**: 

- 当A收到B的ARP响应后，会将B的IP地址和MAC地址的映射写入A的ARP缓存表中。

  > 在局域网子网内的通信过程中，一旦ARP请求的发起者获得了目标设备的MAC地址，它就可以开始使用这个物理地址来发送数据帧到局域网中的目标设备。

  > [!caution]
  >
  > 现在ARP协议可以跟踪请求状态(INCOMPLETE,FAILED等)

## DHCP协议

- DHCP协议又称动态主机配置协议,是一种常见的网络管理协议,主要为客户端提供

  - IP地址
  - 子网掩码
  - 路由器的IP地址
  - 域名服务器的IP地址

- DHCP服务器的两个数据库

  - 静态IP池: MAC地址与IP固定绑定(用于服务器,打印机等需要固定IP的设备)
  - 服务器在动态池之前检查静态池的匹配项
  - 动态池
    - 地址是临时的(默认租期为1小时)
    - 租期到期后,客户端必须请求续约
    - 如果续约请求被拒绝,客户端必须放弃IP地址

- DHCP协议报文字段

  ![image-20251207193049969](./3_%E5%B1%80%E5%9F%9F%E7%BD%91%E5%AE%89%E5%85%A8.assets/image-20251207193049969.png)

- DHCP协议交互过程

  - **发现阶段**.DHCP客户端以广播的方式发送DHCP Discover报文,用于请求IP地址分配

  - **提供阶段**.DHCP服务器收到DHCP DIscover报文后发送一条响应报文 DHCP Offer, 报文中包含了DHCP服务器的IP、可以分配给客户端的IP和其他信息，如子网掩码、网关等

  - **请求阶段**: DHCP客户端在收到DHCP Offer,选择第一个接收到的DHCP Offer,并再次以广播的方式发送一条DHCP Request报文,通知服务器此时客户端选择的配置

  - **确认阶段**.DHCP服务器收到DHCP Request报文后,向DHCP客户端发送一条响应报文DHCP ACK,确定分配的IP地址以及分配的时长.此时DHCP客户端就可以使用这个IP地址了

  - **更新阶段**.当租用期过了一半时,DHCP客户端发送DHCP Request报文,请求更新(Rnew)租用期,然后重新设置计时器;若DHCP服务器同意,就发送响应报文DHCP ACK;繁殖发送响应报文DHCP NACK,此时DHCP客户端必须停止使用原来的IP地址,然后重新申请新的IP地址(回到第一步);若DHCP服务器没有响应,则在租用期过了87.5%时重复次步骤.

  - **释放阶段**.DHCP客户端可以通过向DHCP服务器发送DHCP Release释放报文,随时申请提前终止DHCP所提供的租用期.

    ```mermaid
    sequenceDiagram
        participant C as 客户端
        participant S1 as DHCP Server 1
        participant S2 as DHCP Server 2
    
        Note over C: 无IP地址状态
    
        rect rgb(200, 230, 255)
            Note over C,S2: DORA 四步流程 (初始获取)
            C->>+S1: ① DHCP Discover (广播)
            C->>+S2: ① DHCP Discover (广播)
            S1-->>C: ② DHCP Offer (IP=192.168.1.100)
            S2-->>C: ② DHCP Offer (IP=192.168.1.200)
            Note over C: 选择第一个收到的Offer
            C->>S1: ③ DHCP Request (广播，选择Server1)
            C->>S2: ③ DHCP Request (广播，通知未选中)
            S2-->>S2: 回收IP
            S1-->>C: ④ DHCP ACK (确认IP=192.168.1.100)
        end
    
        Note over C: BOUND状态<br/>开始使用IP
    
        rect rgb(255, 240, 200)
            Note over C,S1: 租约续期 (T1=50%)
            C->>S1: ⑤ DHCP Request (单播续约)
            S1-->>C: DHCP ACK (续约成功)
            Note over C: 重置租期计时器
        end
    
        rect rgb(255, 220, 200)
            Note over C,S2: 租约续期失败场景 (T2=87.5%)
            C->>S1: DHCP Request (单播)
            Note over S1: 服务器无响应
            C->>S1: DHCP Request (广播)
            C->>S2: DHCP Request (广播)
            S2-->>C: DHCP NAK (拒绝)
        end
    
        Note over C: 必须放弃IP<br/>重新开始
    
        rect rgb(220, 255, 220)
            Note over C,S1: 主动释放
            C->>S1: ⑥ DHCP Release
            Note over S1: 回收IP到地址池
        end
    
        Note over C: 回到无IP状态
    ```

## MAC地址洪泛攻击

## MAC地址洪泛攻击的原理

> 在以太网中，数据通过帧的形式进行传输。在帧的传输过程中，常使用交换机进行帧的转发。交换机能根据帧中的目标MAC地址来决定将帧转发到哪个端口，它将网络设备的MAC地址及其对应的端口信息存储在MAC地址表中.

- MAC地址表的容量是有限的.当MAC地址表存储到达上限后,交换机就无法再存储新的MAC地址机器对应的端口信息.
- 此时如果再收到含有不在地址表中的MAC地址的帧时,==交换机就会进行广播,向所有接口转发这个数据帧==
- 基于此机制,攻击者可以进行MAC地址洪泛攻击

### MAC地址洪泛攻击的步骤

1. 攻击者发送大量伪造的数据帧.攻击者通过向网络中注入大量伪造的数据帧,以填满交换机的MAC地址表
2. 交换机无法正常处理新到达的数据帧.当交换机的MAC地址表填满后,交换机无法再将新的MAC地址和端口对应起来
3. 交换机广播收到的数据帧.在无法正确转发数据帧时,交换机会将数据帧广播到所有连接的端口上.此时==攻击者可接收到受害者的数据帧==,然后借助如Wireshark等工具获取数据信息

> [!note]
>
> 防护措施
>
> - 端口安全:限制每个端口可学习的MAC数量
> - 静态MAC绑定: 手动配置MAC-端口映射
> - 802.1x认证: 设备接入前需要认证
> - 私有VLAN: 隔离同一VLAN内的主机

## ARP攻击

### ARP缓存投毒攻击的原理

- 利用了==ARP协议缺乏有效验证机制==无法确保ARP响应的真实性的缺陷
- 该攻击使得攻击者能够通过==破坏网络的MAC地址表==来截获篡改或中断网络设备之间的通信
- 通过两种方式来实施
  - 利用ARP Reply令目标主机(发送ARP响应的设备)在受害者(发送ARP请求的设备)的ARP缓存中失效
  - 利用ARP Request令受害者在目标主机的ARP缓存中失效

### ARP缓存投毒攻击的步骤

**ARP Reply方式**

1. 受害者广播ARP请求,此时攻击者也可收到这个广播消息
2. 攻击者==比服务器更快地回应伪造的ARP响应==.这导致受害者ARP缓存表中记录了错误的映射
3. 受害者发送给服务器的流量被攻击者截获

> 由于受害者的ARP缓存表被投毒,导致发送给服务器的数据包的目的MAC地址被错误的MAC地址(攻击者的MAC地址)所填充,从而被攻击者拦截

**ARP Request方式**

1. 攻击者向服务器发送虚假的ARP请求(以受害者的IP和攻击者的MAC地址)
2. 服务器被欺骗,将==受害者的IP地址与攻击者的MAC地址==相映射,使得服务器端的ARP缓存表中出现错误的映射
3. 攻击者成功投毒服务器端MAC地址表,可引导网络流量通过攻击者的计算机

### 终端主机欺骗攻击

利用ARP缓存投毒攻击可以实现终端主机欺骗.假设主机A和攻击者都连接到同一网关上,然后通过路由设备连入互联网.主要步骤如下:

1. 攻击者发送伪造数据包.攻击者主要利用ARP缓存投毒攻击将网关的MAC地址表中与主机A的IP地址所对应的主机A的物理地址(MAC地址)污染成为攻击者的物理地址(MAC地址)
2. 服务器与攻击者通信.当网关的MAC地址表污染完成后,网络中的网关可以正常接收来自主机A的网络包并将其传递到互联网的服务器.但是受其MAC地址表被污染的影响,会将==来自互联网侧的需要传递给主机A的数据包首先发送给攻击者==,然后攻击者在做了一定处理后再转发给主机A.

### 网关欺骗攻击

利用ARP缓存投毒攻击也可以实现网关欺骗.假设服务器和攻击者都连接到同一网关上,然后通过路由设备连入互联网.

1. 攻击者发送伪造数据包. 攻击者主要利用ARP缓存投毒攻击,将服务器的ARP缓存表中与==网关的IP地址所对应的原网关物理地址污染为攻击者的物理地址==
2. 服务器与攻击者通信.污染完成后,网络中的服务器可以通过网关正常接收来自主机A的网络包,但是==传递给主机A的响应包首先发给攻击者==,然后攻击者在做了一定处理后再转发给网关,最后到达主机A.

### 中间人(Telnet)攻击

> 中间人攻击是在ARP缓存投毒攻击的基础上,劫持受害和主机与网络服务器之间的数据流量.在劫持攻击发生前,攻击者主机定期向局域网广播伪造的ARP应答报文.在ARP应答报文中,攻击者主机将网络服务器IP地址与自身MAC地址进行绑定.一旦受害者主机接收到该ARP应答报文,其MAC地址表会创建一条将服务器的IP地址与攻击者主机MAC地址绑定在一起的ARP表项

1. 受害者流量被中间人劫持.

   - 受害者主机一旦建立了错误的MAC地址表项,其对网络服务器访问的IP分组被封装成MAC帧,
   - 帧的目的MAC地址为攻击者主机的MAC地址,
   - 而目的IP地址为网络服务器的IP地址

2. 中间人转发流量到服务器

   - 攻击者主机启用了IP转发功能,将劫持的数据流量转发到真正的服务器,使得服务器能够正常接收并响应来自受害者主机的访问请求

   - 在其转发之前,攻击者可以修改相关帧的载荷,如可以说极限Telnet反弹

   - 这样劫持数据流量攻击行为不易被察觉

     > [!note]
     >
     > Telnet反弹shell: 攻击者让目标主机*主动*连接回攻击者控制的服务器，并在这条连接上提供一个交互式的 shell，从而让攻击者获得目标主机的命令执行能力。

## DHCP攻击

### DHCP劫持攻击

1. 响应DHCP请求.当网络内的客户端设备发出DHCP请求(寻求IP配置时),伪造的DHCP服务器尝试比合法的DHCP服务器更快地响应这些请求,以确保客户端接收其(攻击者)提供的配置信息.
2. 劫持网络流量.一旦客户端使用了伪造的DHCP服务器提供的配置信息,其对外请求的流量都可能使用攻击者指定的网关和DNS服务器,使得攻击者能够监视、拦截或篡改网络流量

### DHCP拒绝服务攻击

> DHHCP拒绝服务攻击是一种恶意行为,目的是==通过使DHCP服务器无法正常工作,导致网络中的设备无法获取有效的IP地址配置==

- 攻击者通过不断发送DHCP请求消息
- 解析收到的DHCP offfer数据包并提取相关信息,构建大量的DHCP Request数据包,这些数据包使用不同的、多为伪造的MAC地址
- 致使DHCP服务器尝试为每个请求分配IP地址，以大量占用DHCP服务器的资源和带宽，导致DHCP服务器（Server）上可用于分配的地址资源耗尽，从而使得正常的DHCP服务受到影响。

